/**
 * Copyright 2016 PhenixP2P Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
define("sdk/MQProtocol",["protobuf"],function(a){"use strict";function b(){var b=a.loadJson(e);b=a.loadJson(f,b),b=a.loadJson(g,b),this._builders=b.build(),this._apiVersion=2}function c(a){for(var b=a.split("."),c=this._builders,d=0;d<b.length-1;d++)if(c=c[b[d]],!c)throw new Error('Unsupported type "'+a+'"');if(c=c[b[b.length-1]],"function"!=typeof c)throw new Error('Unsupported type "'+a+'"');return c}function d(a){if(a&&a.$type&&a.$type.children)for(var b in a.$type.children){var c=a.$type.children[b],e=a[c.name],f=c&&c.element?c.element.resolvedType:null;if(f&&"Message"===f.className&&f.children)a[c.name]=d(e);else if(f&&"Enum"===f.className&&f.children){for(var g=null,h=0;h<f.children.length;h++)if(f.children[h].id===e){g=f.children[h];break}g&&g.name&&(a[c.name]=g.name)}}return a}var e='{"package":"mq","messages":[{"name":"Request","fields":[{"rule":"optional","type":"string","name":"sessionId","id":1},{"rule":"optional","type":"string","name":"requestId","id":2},{"rule":"required","type":"string","name":"type","id":3},{"rule":"optional","type":"string","name":"encoding","id":4},{"rule":"required","type":"bytes","name":"payload","id":5}]},{"name":"Response","fields":[{"rule":"optional","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"requestId","id":2},{"rule":"required","type":"string","name":"type","id":3},{"rule":"optional","type":"string","name":"encoding","id":4},{"rule":"required","type":"bytes","name":"payload","id":5},{"rule":"repeated","type":"double","name":"wallTime","id":6}]},{"name":"Error","fields":[{"rule":"required","type":"string","name":"reason","id":1}]},{"name":"PingPong","fields":[{"rule":"required","type":"uint64","name":"originTimestamp","id":1},{"rule":"optional","type":"uint64","name":"count","id":2}]}]}',f='{"package":"pcast","messages":[{"name":"Authenticate","fields":[{"rule":"optional","type":"uint32","name":"apiVersion","id":9,"options":{"default":0}},{"rule":"required","type":"string","name":"clientVersion","id":1},{"rule":"optional","type":"string","name":"device","id":12},{"rule":"required","type":"string","name":"deviceId","id":2},{"rule":"optional","type":"string","name":"manufacturer","id":13},{"rule":"required","type":"string","name":"platform","id":3},{"rule":"required","type":"string","name":"platformVersion","id":4},{"rule":"required","type":"string","name":"authenticationToken","id":5},{"rule":"optional","type":"string","name":"connectionId","id":6},{"rule":"optional","type":"string","name":"connectionRouteKey","id":10},{"rule":"optional","type":"string","name":"remoteAddress","id":11},{"rule":"optional","type":"string","name":"sessionId","id":7},{"rule":"optional","type":"string","name":"applicationId","id":8}]},{"name":"AuthenticateResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"sessionId","id":2},{"rule":"optional","type":"string","name":"redirect","id":3}]},{"name":"Bye","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"reason","id":2}]},{"name":"ByeResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"SessionDescription","fields":[{"rule":"required","type":"Type","name":"type","id":1,"options":{"default":"Offer"}},{"rule":"required","type":"string","name":"sdp","id":2}],"enums":[{"name":"Type","values":[{"name":"Offer","id":0},{"name":"Answer","id":1}]}]},{"name":"CreateStream","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"optional","type":"string","name":"originStreamId","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"repeated","type":"string","name":"tags","id":4},{"rule":"optional","type":"SetRemoteDescription","name":"setRemoteDescription","id":5},{"rule":"optional","type":"CreateOfferDescription","name":"createOfferDescription","id":6},{"rule":"optional","type":"CreateAnswerDescription","name":"createAnswerDescription","id":7}]},{"name":"CreateStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"streamId","id":2},{"rule":"optional","type":"string","name":"instanceRouteKey","id":5},{"rule":"optional","type":"SetRemoteDescriptionResponse","name":"setRemoteDescriptionResponse","id":3},{"rule":"optional","type":"CreateOfferDescriptionResponse","name":"createOfferDescriptionResponse","id":4},{"rule":"optional","type":"CreateAnswerDescriptionResponse","name":"createAnswerDescriptionResponse","id":6}]},{"name":"SetLocalDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"SetLocalDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"SetRemoteDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"SetRemoteDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2}]},{"name":"CreateOfferDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"repeated","type":"string","name":"options","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"CreateOfferDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2}]},{"name":"CreateAnswerDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"repeated","type":"string","name":"options","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"CreateAnswerDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2}]},{"name":"UpdateStreamState","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"string","name":"signalingState","id":2},{"rule":"required","type":"string","name":"iceGatheringState","id":3},{"rule":"required","type":"string","name":"iceConnectionState","id":4}]},{"name":"DestroyStream","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"optional","type":"string","name":"reason","id":2}]},{"name":"DestroyStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"StreamStarted","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"repeated","type":"string","name":"tags","id":3}]},{"name":"StreamEnded","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"string","name":"reason","id":3}]},{"name":"StreamEndedResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"StreamArchived","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"string","name":"uri","id":3}]},{"name":"SessionEnded","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"reason","id":2},{"rule":"required","type":"float","name":"duration","id":3}]},{"name":"IssueAuthenticationToken","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"repeated","type":"string","name":"capabilities","id":3}]},{"name":"IssueAuthenticationTokenResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"authenticationToken","id":2}]},{"name":"IssueStreamToken","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"required","type":"string","name":"sessionId","id":3},{"rule":"optional","type":"string","name":"originStreamId","id":4},{"rule":"repeated","type":"string","name":"capabilities","id":5}]},{"name":"IssueStreamTokenResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"streamToken","id":2}]},{"name":"Stream","fields":[{"rule":"required","type":"string","name":"streamId","id":1}]},{"name":"ListStreams","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"optional","type":"string","name":"start","id":3},{"rule":"required","type":"uint32","name":"length","id":4}]},{"name":"ListStreamsResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"start","id":2},{"rule":"optional","type":"uint32","name":"length","id":3},{"rule":"repeated","type":"Stream","name":"streams","id":4}]},{"name":"TerminateStream","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"required","type":"string","name":"streamId","id":3},{"rule":"optional","type":"string","name":"reason","id":4}]},{"name":"TerminateStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"SetupStream","fields":[{"rule":"required","type":"string","name":"streamToken","id":1},{"rule":"required","type":"CreateStream","name":"createStream","id":2}]},{"name":"SetupStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"CreateStreamResponse","name":"createStreamResponse","id":2}]},{"name":"EndStream","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"optional","type":"string","name":"reason","id":2,"options":{"default":"ended"}}]},{"name":"EndStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"StreamDataQuality","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3},{"rule":"required","type":"DataQualityStatus","name":"status","id":4},{"rule":"required","type":"DataQualityReason","name":"reason","id":5}],"enums":[{"name":"DataQualityStatus","values":[{"name":"NoData","id":0},{"name":"AudioOnly","id":1},{"name":"All","id":2}]},{"name":"DataQualityReason","values":[{"name":"None","id":0},{"name":"UploadLimited","id":1},{"name":"DownloadLimited","id":2},{"name":"PublisherLimited","id":3},{"name":"NetworkLimited","id":4}]}]},{"name":"StreamDataQualityResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]}]}',g='{"package":"chat","messages":[{"name":"Room","fields":[{"rule":"optional","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"name","id":2},{"rule":"required","type":"string","name":"description","id":3},{"rule":"required","type":"RoomType","name":"type","id":4},{"rule":"repeated","type":"string","name":"options","id":5}]},{"name":"Stream","fields":[{"rule":"required","type":"StreamType","name":"type","id":1},{"rule":"required","type":"string","name":"uri","id":2},{"rule":"required","type":"TrackState","name":"audioState","id":3},{"rule":"required","type":"TrackState","name":"videoState","id":4}]},{"name":"Member","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"screenName","id":2},{"rule":"required","type":"MemberRole","name":"role","id":3},{"rule":"repeated","type":"Stream","name":"streams","id":4},{"rule":"required","type":"uint64","name":"lastUpdate","id":7}]},{"name":"CreateRoom","fields":[{"rule":"required","type":"Room","name":"room","id":1}]},{"name":"CreateRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"roomId","id":2}]},{"name":"JoinRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"sessionId","id":2},{"rule":"required","type":"Member","name":"member","id":3},{"rule":"repeated","type":"string","name":"options","id":4},{"rule":"required","type":"uint64","name":"timestamp","id":5}]},{"name":"JoinRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"Room","name":"room","id":2},{"rule":"repeated","type":"Member","name":"members","id":3},{"rule":"repeated","type":"string","name":"options","id":4}]},{"name":"UpdateRoom","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"Room","name":"room","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3}]},{"name":"UpdateRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"UpdateMember","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"Member","name":"member","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"required","type":"uint64","name":"timestamp","id":4}]},{"name":"UpdateMemberResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"LeaveRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"sessionId","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3}]},{"name":"LeaveRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"DestroyRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1}]},{"name":"DestroyRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"RoomEvent","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"roomId","id":2},{"rule":"required","type":"RoomEventType","name":"eventType","id":3},{"rule":"repeated","type":"Member","name":"members","id":4},{"rule":"optional","type":"Room","name":"room","id":5},{"rule":"repeated","type":"string","name":"options","id":6},{"rule":"required","type":"uint64","name":"timestamp","id":7}]}],"enums":[{"name":"RoomType","values":[{"name":"DirectChat","id":0},{"name":"MultiPartyChat","id":1},{"name":"ModeratedChat","id":2},{"name":"TownHall","id":3}]},{"name":"MemberRole","values":[{"name":"Participant","id":0},{"name":"Moderator","id":1},{"name":"Presenter","id":2},{"name":"Audience","id":3}]},{"name":"RoomEventType","values":[{"name":"MemberJoined","id":0},{"name":"MemberLeft","id":1},{"name":"MemberUpdated","id":2},{"name":"Updated","id":3},{"name":"Ended","id":4}]},{"name":"TrackState","values":[{"name":"Enabled","id":0},{"name":"Disabled","id":1},{"name":"Ended","id":2}]},{"name":"StreamType","values":[{"name":"User","id":0},{"name":"Presentation","id":1}]}]}';return b.prototype.getApiVersion=function(){return this._apiVersion},b.prototype.encode=function(a,b){if("string"!=typeof a)throw new Error("'type' must be a string");if("object"!=typeof b)throw new Error("'data' must be an object");var d=c.call(this,a);return d.encode(b)},b.prototype.decode=function(a,b){if("string"!=typeof a)throw new Error("'type' must be a string");var e=c.call(this,a);return d(e.decode(b))},b}),define("sdk/PhenixPCast",["sdk/PhenixProtocol","phenix-rtc"],function(a,b){"use strict";function c(a,c,d){this._baseUri=a||C,this._screenSharingExtensionId=c||D,this._screenSharingAddOn=d||E,this._screenSharingEnabled=!1,this._status="offline","Chrome"===b.browser&&this._screenSharingExtensionId&&f.call(this),b.addEventListener(window,"unload",function(a){return function(){a.stop()}}(this))}function d(a){var c=this;if("Chrome"===b.browser&&c._screenSharingExtensionId)try{chrome.runtime.sendMessage(c._screenSharingExtensionId,{type:"version"},function(b){b&&"ok"===b.status?(w('Screen sharing enabled using version "'+b.version+'"'),a(!0)):(w("Screen sharing NOT available"),a(!1))})}catch(d){d.message&&x(d.message),a(!1)}else a("Firefox"===b.browser&&"object"==typeof window.PCastScreenSharing?!0:!1)}function e(){return"https://chrome.google.com/webstore/detail/"+this._screenSharingExtensionId}function f(){for(var a=e.call(this),b=document.getElementsByTagName("link"),c=0;c<b.length;c++)if(b[c].href===a)return;w('Adding Chrome Web Store link "'+a+'"');var d=document.createElement("link");d.rel="chrome-webstore-item",d.href=a,document.getElementsByTagName("head")[0].appendChild(d)}function g(a){var b=e.call(this);try{chrome.webstore.install(b,function(){a("ok")},function(b){b&&x(b),a("failed",new Error(b||"failed"))})}catch(c){c.message&&x(c.message),a("failed",c)}}function h(a){try{var b,c={"PCast Screen Sharing":{URL:this._screenSharingAddOn.url,IconURL:this._screenSharingAddOn.iconUrl,Hash:this._screenSharingAddOn.hash,toString:function(){return this.URL}}},d=G,e=function(){b&&clearInterval(b),a("ok")},f=function(){b&&clearInterval(b),a("failed",new Error("failed"))};b=setInterval(function(){return"object"==typeof window.PCastScreenSharing?e():d--<0?f():void 0},F),InstallTrigger.install(c,function(a,b){0===b?e():f()})}catch(g){g.message&&x(g.message),a("failed",g)}}function i(a){var c=this;switch(b.browser){case"Chrome":try{chrome.runtime.sendMessage(c._screenSharingExtensionId,{type:"get-desktop-media"},function(b){if("ok"!==b.status)return a(b.status,void 0,new Error(b.status));var c={video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:b.streamId}}};a("ok",c,void 0)})}catch(d){d.message&&x(d.message),a("failed",void 0,d)}break;case"Firefox":var e={video:{mediaSource:"window"}};a("ok",e,void 0);break;default:a("not-supported",void 0,new Error("not-supported"))}}function j(a,c){var e=this;if(a.screen)if(e._screenSharingEnabled)i.call(e,c);else{var f=function(a){return"ok"!==a?c(a,void 0,new Error("screen-sharing-installation-failed")):void d.call(e,function(b){return e._screenSharingEnabled=b,e._screenSharingEnabled?void i.call(e,c):c(a,void 0,new Error("screen-sharing-installation-failed"))})};switch(b.browser){case"Chrome":g.call(e,f);break;case"Firefox":h.call(e,f);break;default:c("not-supported",void 0,new Error("not-supported"))}}else{var j={audio:a.audio||!1,video:a.video||!1};c("ok",j,void 0)}}function k(a,c){var d=this,e=function(a){d._gumStreams.push(a),c(this,"ok",a)},f=function(a){"unavailable"===a.code?c(this,"conflict",void 0,a):"permission-denied"===a.message?c(this,"permission-denied",void 0,a):"PermissionDeniedError"===a.name?c(this,"permission-denied",void 0,a):"InternalError"===a.name&&"Starting video failed"===a.message?c(this,"conflict",void 0,a):"SourceUnavailableError"===a.name?c(this,"conflict",void 0,a):"SecurityError"===a.name&&"The operation is insecure."===a.message?c(this,"permission-denied",void 0,a):c(this,"failed",void 0,a)};j.call(d,a,function(a,c,d){if("ok"!==a)return f(d);try{b.getUserMedia(c,e,f)}catch(g){f(g)}})}function l(){var a=this;this._connected=!0,this._stopped||this._protocol.authenticate(this._authToken,function(b,c){a._authenticationCallback&&(c?(x("Failed to authenticate: "+JSON.stringify(c)),t.call(a,"offline"),a._authenticationCallback.call(a,a,"unauthorized",""),a.stop("unauthorized")):(t.call(a,"online"),a._authenticationCallback.call(a,a,b.status,b.sessionId)))})}function m(){this._connected=!1,t.call(this,"offline")}function n(a){switch(a){case"":case"none":case"ended":return"ended";case"server-error":case"not-ready":case"error":return"failed";case"censored":return"censored";case"maintenance":return"maintenance";case"capacity":return"capacity";case"app-background":return"app-background";default:return"custom"}}function o(a){var b=a.streamId,c=a.reason;return q.call(this,b,c)}function p(a){var b=a.streamId,c=a.status,d=a.reason,e=this._renderer[b];e&&"function"==typeof e.dataQualityChangedCallback&&e.dataQualityChangedCallback(e,c,d);var f=this._publishers[b];f&&"function"==typeof f.dataQualityChangedCallback&&f.dataQualityChangedCallback(f,c,d)}function q(a,b){var c=this._mediaStreams[a];c&&"function"==typeof c.streamEnded&&c.streamEnded(c,n(b),b),delete this._mediaStreams[a];var d=this._renderer[a];d&&c.stop(),delete this._renderer[a];var e=this._publishers[a];e&&"function"==typeof e.publisherEndedCallback&&e.publisherEndedCallback(e,n(b),b),delete this._publishers[a];var f=this._peerConnections[a];f&&"closed"!==f.signalingState&&f.close(),delete this._peerConnections[a]}function r(a,c,d,e){function f(){function a(a){w("Created answer: "+a.sdp),g._protocol.setAnswerDescription(c,a.sdp,function(a,f){function i(){var a=/(b=AS:([0-9]*)[\n\r]*)/gi,b=/(mid:video)([\n\r]*)/gi;w("Set local description (answer)");var f=0,i=a.exec(d);i&&i.length>=3&&(f=1e3*i[2]);var k={getStreamId:function(){return c},hasEnded:function(){switch(j.iceConnectionState){case"new":case"checking":case"connected":case"completed":return!1;case"disconnected":case"failed":case"closed":return!0;default:return!0}},stop:function(a){"closed"!==j.signalingState&&j.close(),h||(g._protocol.destroyStream(c,a||"",function(a,b){return b?void x("["+c+"] failed to destroy stream"):void w("["+c+"] destroyed stream")}),h=!0)},setPublisherEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.publisherEndedCallback=a},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a},limitBandwidth:function(c){if("number"!=typeof c)throw new Error('"bandwidthLimit" must be a number');var d=f?Math.min(c,f):c,e=j.remoteDescription;w("Changing bandwidth limit to",d);var g=e.sdp.replace(a,"");return g=g.replace(b,function(a,b,c,e,f){return[b,c,"b=AS:",Math.ceil(d/1e3),c].join("")}),j.setRemoteDescription({type:e.type,sdp:g}),{dispose:function(){j.setRemoteDescription(e)}}}};g._publishers[c]=k,e.call(g,k)}if(f)return x("Failed to set answer description: "+JSON.stringify(f)),k();var l=new b.RTCSessionDescription({type:"answer",sdp:a.sessionDescription.sdp});j.setLocalDescription(l,i,k)})}w("Set remote description (offer)"),j.createAnswer(a,k,A)}var g=this,h=!1,i=!1,j=new b.RTCPeerConnection(y,z);g._peerConnections[c]=j,j.addStream(a);var k=function(){i||(i=!0,h=!0,delete g._peerConnections[c],"closed"!==j.signalingState&&j.close(),e.call(g,void 0,"failed"))},l=new b.RTCSessionDescription({type:"offer",sdp:d});j.setRemoteDescription(l,f,k);var m=function(a){var b=a.candidate;w(b?"["+c+"] ICE candidate (publisher): "+b.sdpMid+" "+b.sdpMLineIndex+" "+b.candidate:"["+c+"] ICE candidate discovery complete (publisher)")};b.addEventListener(j,"icecandidate",m)}function s(a,c,d){function e(){function c(c){w("Created answer: "+c.sdp),f._protocol.setAnswerDescription(a,c.sdp,function(a,c){function d(){w("Set local description (answer)")}if(c)return x("Failed to set answer description: "+JSON.stringify(c)),k();var e=new b.RTCSessionDescription({type:"answer",sdp:a.sessionDescription.sdp});i.setLocalDescription(e,d,k)})}w("Set remote description (offer)"),i.createAnswer(c,k,B)}var f=this,g=!1,h=!1,i=new b.RTCPeerConnection(y,z);f._peerConnections[a]=i;var j=function(c){if(!g){var e=c.stream;console.log("Got a remote stream");var j={createRenderer:function(){return{start:function(c){return this.element=b.attachMediaStream(c,e),f._renderer[a]=this,this.element},stop:function(){this.element&&this.element.pause(),delete f._renderer[a]},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a}}},setStreamEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamEnded=a},stop:function(b){"closed"!==i.signalingState&&i.close(),h||(f._protocol.destroyStream(a,b||"",function(b,c){return c?void x("["+a+"] failed to destroy stream"):void w("["+a+"] destroyed stream")}),h=!0)}};f._mediaStreams[a]=j,d.call(f,j)}},k=function(){g||(g=!0,delete f._peerConnections[a],"closed"!==i.signalingState&&i.close(),d.call(f,void 0,"failed"))};b.addEventListener(i,"addstream",j);var l=function(b){var c=b.candidate;w(c?"["+a+"] ICE candidate (viewer): "+c.sdpMid+" "+c.sdpMLineIndex+" "+c.candidate:"["+a+"] ICE candidate discovery complete (viewer)")};b.addEventListener(i,"icecandidate",l);var m=new b.RTCSessionDescription({type:"offer",sdp:c});i.setRemoteDescription(m,e,k)}function t(a){if(this._status!==a)switch(this._status=a,a){case"connecting":break;case"offline":this._offlineCallback.call(this);break;case"online":this._onlineCallback.call(this)}}function u(a,b){var c=this;0===a.lastIndexOf("wss:",0)?b.call(c,void 0,a+"/ws"):0===a.lastIndexOf("https:",0)?v(a+"/pcast/endPoints",function(a,c){if(a)return b(new Error("Failed to resolve an end point",a)),b(a);var d=c.split(",");d.length<1&&b(new Error("Failed to discover end points"));for(var e=!1,f=d.length,g=0;g<d.length;g++){var h=d[g];w('Checking end point "'+h+'"'),v(h,function(a,c){a?w('Failed to resolve endPoint "'+h+'": '+a):e||(e=!0,b(void 0,c)),f--,0!==f||e||b(new Error("Failed to resolve an end point"))})}}):b.call(c,new Error("Uri not supported"))}function v(a,b,c){void 0===c&&(c=1);var d=new XMLHttpRequest;d.open("GET",a,!0),d.addEventListener("readystatechange",function(e){4===d.readyState&&(200===d.status?b(void 0,d.responseText):d.status>=500&&d.status<600&&H>=c?v(a,b,c+1):w('HTTP GET "'+a+'" failed with "'+d.status+'" "'+d.statusText+'"'))}),d.send()}var w=function(){console.log.apply(console,arguments)}||function(){},x=function(){console.error.apply(console,arguments)}||w,y={iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}]},z={optional:[{DtlsSrtpKeyAgreement:!1},{RtpDataChannels:!1}]},A={mandatory:{OfferToReceiveVideo:!1,OfferToReceiveAudio:!1}},B={mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}},C="https://pcast.phenixp2p.com",D="icngjadgidcmifnehjcielbmiapkhjpn",E={url:"https://addons.mozilla.org/firefox/downloads/file/474686/pcast_screen_sharing-1.0.3-an+fx.xpi",iconUrl:"https://phenixp2p.com/public/images/phenix-logo-unicolor-64x64.png",hash:"sha256:337cd01d283e0682e7560b3a8d7957e7139e19c4297d947bb284709a39fe7918"},F=100,G=450;c.prototype.getBaseUri=function(){return this._baseUri},c.prototype.getStatus=function(){return this._status},c.prototype.start=function(b,c,e,f){if("string"!=typeof b)throw new Error('"authToken" must be a string');if("function"!=typeof c)throw new Error('"authenticationCallback" must be a function');if("function"!=typeof e)throw new Error('"onlineCallback" must be a function');if("function"!=typeof f)throw new Error('"offlineCallback" must be a function');if(this._started)throw new Error('"Already started"');this._stopped=!1,this._started=!0,this._authToken=b,this._authenticationCallback=c,this._onlineCallback=e,this._offlineCallback=f,this._status="connecting",this._peerConnections={},this._mediaStreams={},this._renderer={},this._publishers={},this._gumStreams=[];var g=this;d.call(g,function(b){g._screenSharingEnabled=b,u.call(g,g._baseUri,function(b,c){return b?(x("Failed to connect to "+g._baseUri,b),t.call(g,"offline"),g._authenticationCallback.call(g,g,"unauthorized",""),g._stopped=!0,void(g._started=!1)):(w('Discovered end point "'+c+'"'),g._protocol=new a(c),g._protocol.on("connected",l.bind(g)),g._protocol.on("disconnected",m.bind(g)),g._protocol.on("streamEnded",o.bind(g)),void g._protocol.on("dataQuality",p.bind(g)))})})},c.prototype.stop=function(){if(this._started){this._stopped=!0,this._started=!1,delete this._authenticationCallback;try{var a="";for(var b in this._mediaStreams)if(this._mediaStreams.hasOwnProperty(b)){var c=this._mediaStreams[b];q.call(this,b,a),c.stop(a)}for(var b in this._renderer)if(this._renderer.hasOwnProperty(b)){var d=this._renderer[b];d.stop(a)}for(var b in this._publishers)if(this._publishers.hasOwnProperty(b)){var e=this._publishers[b];q.call(this,b,a),e.stop(a)}for(var b in this._peerConnections)this._peerConnections.hasOwnProperty(b)&&q.call(this,b,a);for(var f=0;f<this._gumStreams.length;f++)for(var g=this._gumStreams[f].getTracks(),h=0;h<g.length;h++)g[h].stop()}finally{this._protocol&&this._protocol.disconnect()}}},c.prototype.getUserMedia=function(a,b){if("object"!=typeof a)throw new Error('"options" must be an object');if("function"!=typeof b)throw new Error('"callback" must be a function');return k.call(this,a,b)},c.prototype.publish=function(a,b,c,d){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("object"!=typeof b)throw new Error('"mediaStreamToPublish" must be an object');if("function"!=typeof c)throw new Error('"callback" must be a function');if(d=d||[],!Array.isArray(d))throw new Error('"tags" must be an array');var e=this;this._protocol.createUploader(a,function(a,d){if(d)x("Failed to create uploader: "+JSON.stringify(d)),c.call(e,e,"failed");else{var f=a.createStreamResponse.streamId,g=a.createStreamResponse.createOfferDescriptionResponse.sessionDescription.sdp;r.call(e,b,f,g,function(a,b){b?c.call(e,e,"failed",null):c.call(e,e,"ok",a)})}})},c.prototype.subscribe=function(a,b){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var c=this;this._protocol.createDownloader(a,function(a,d){if(d)x("Failed to create downloader: "+JSON.stringify(d)),b.call(c,c,"failed");else{var e=a.createStreamResponse.streamId,f=a.createStreamResponse.createOfferDescriptionResponse.sessionDescription.sdp;s.call(c,e,f,function(a,d){d?b.call(c,c,"failed",null):b.call(c,c,"ok",a)})}})},c.prototype.toString=function(){return"PhenixPCast["+this._sessionId+","+this._protocol.toString()+"]"};var H=3;return c}),define("sdk/PhenixProtocol",["sdk/MQProtocol","ByteBuffer","phenix-rtc"],function(a,b,c){"use strict";function d(b){this._uri=b,this._mqProtocol=new a,l("Connecting to "+b),this._webSocket=new WebSocket(b),this._webSocket.onopen=h.bind(this),this._webSocket.onclose=i.bind(this),this._webSocket.onmessage=j.bind(this),this._webSocket.onerror=k.bind(this),this._nextRequestId=0,this._events={},this._requests={}}function e(a,b,c){var d=(this._nextRequestId++).toString(),e={requestId:d,type:a,payload:this._mqProtocol.encode(a,b)};return this._requests[d]=c,this._webSocket.send(this._mqProtocol.encode("mq.Request",e).toString("base64"))}function f(a){var b=this._events[a];return b||(this._events[a]=b=[]),b}function g(a,b){var c=this._events[a];if(c)for(var d=0;d<c.length;d++)c[d].apply(this,b)}function h(a){l("Connected"),g.call(this,"connected")}function i(a){l("Disconnected ["+a.code+"]: "+a.reason),g.call(this,"disconnected",[a.code,a.reason])}function j(a){l(">> "+a.data);var c=this._mqProtocol.decode("mq.Response",b.wrap(a.data,"base64"));l(">> "+c.type);var d=this._mqProtocol.decode(c.type,c.payload);"pcast.AuthenticateResponse"===c.type?this._sessionId=d.sessionId:"pcast.StreamEnded"===c.type?g.call(this,"streamEnded",[d]):"pcast.StreamDataQuality"===c.type&&g.call(this,"dataQuality",[d]);var e=this._requests[c.requestId];e&&(delete this._requests[c.requestId],"mq.Error"===c.type||"ok"!==d.status?e(void 0,d):e(d))}function k(a){m("Error: "+a.data)}var l=function(){console.log.apply(console,arguments)}||function(){},m=function(){console.error.apply(console,arguments)}||l;return d.prototype.on=function(a,b){
if("string"!=typeof a)throw new Error('"eventName" must be a string');if("function"!=typeof b)throw new Error('"handler" must be a function');var c=f.call(this,a);c.push(b)},d.prototype.authenticate=function(a,b){if("string"!=typeof a)throw new Error('"authToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var d={apiVersion:this._mqProtocol.getApiVersion(),clientVersion:"2016-08-11T20:02:59Z",deviceId:"",platform:c.browser,platformVersion:c.browserVersion.toString(),authenticationToken:a};return this._sessionId&&(auth.sessionId=this._sessionId),e.call(this,"pcast.Authenticate",d,b)},d.prototype.disconnect=function(){return delete this._sessionId,this._webSocket.close(1e3,"byebye")},d.prototype.bye=function(a,b){if("string"!=typeof a)throw new Error('"reason" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var c={sessionId:this._sessionId,reason:a};return e.call(this,"pcast.Bye",c,b)},d.prototype.createDownloader=function(a,b){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var d=c.browser||"UnknownBrowser",f=d+"-"+(c.browserVersion||0),g={streamToken:a,createStream:{sessionId:this._sessionId,options:["data-quality-notifications"],createOfferDescription:{streamId:"",options:["download","SRTP",d,f],apiVersion:this._mqProtocol.getApiVersion()}}};return e.call(this,"pcast.SetupStream",g,b)},d.prototype.createUploader=function(a,b){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var d=c.browser||"UnknownBrowser",f=d+"-"+(c.browserVersion||0),g={streamToken:a,createStream:{sessionId:this._sessionId,options:["data-quality-notifications"],createOfferDescription:{streamId:"",options:["upload","SRTP",d,f],apiVersion:this._mqProtocol.getApiVersion()}}};return e.call(this,"pcast.SetupStream",g,b)},d.prototype.setAnswerDescription=function(a,b,c){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"sdp" must be a string');if("function"!=typeof c)throw new Error('"callback" must be a function');var d={streamId:a,sessionDescription:{type:"Answer",sdp:b},apiVersion:this._mqProtocol.getApiVersion()};return e.call(this,"pcast.SetRemoteDescription",d,c)},d.prototype.destroyStream=function(a,b,c){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"reason" must be a string');if("function"!=typeof c)throw new Error('"callback" must be a function');var d={streamId:a,reason:b};return e.call(this,"pcast.DestroyStream",d,c)},d.prototype.toString=function(){return"PhenixProtocol["+this._uri+","+this._webSocket.readyState+"]"},d}),define("phenix-web-sdk",["sdk/PhenixPCast"],function(a){return window.PhenixPCast=a,{PCast:a}});